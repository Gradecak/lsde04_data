<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Netherlands Dike Systems</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.50.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.50.0/mapbox-gl.css' rel='stylesheet' />
    <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
    <script src="proj4.js"></script>
    <style>
     body { margin:0; padding:0; }
     #map { position:absolute; top:0; bottom:0; width:100%; }
    </style>
  </head>
  <body>

    <div id='map'></div>
    <script>
     proj4.defs("EPSG:28992","+proj=sterea +lat_0=52.15616055555555 +lon_0=5.38763888888889 +k=0.9999079 +x_0=155000 +y_0=463000 +ellps=bessel +towgs84=565.417,50.3319,465.552,-0.398957,0.343988,-1.8774,4.0725 +units=m +no_defs");
     proj4.defs("EPSG:4326","+proj=longlat +datum=WGS84 +no_defs");

     mapboxgl.accessToken = 'pk.eyJ1IjoiY2FicmVubiIsImEiOiJjam5iMDFhbGw1YmlsM3BvODNuM2NqemFxIn0.LKFZPukxR3zFIMvnSfy0UQ';
     var map = new mapboxgl.Map({
       container: 'map',
       style: 'mapbox://styles/mapbox/streets-v9?optimize=true',
       center: [4.161917661708293,51.30563120624621],
       zoom: 10
     });

     var base_url = "https://raw.githubusercontent.com/gradecak/lsde04_data/master/"
     map.on('load', function () {


       $.getJSON("https://gradecak.github.io/lsde04_data/png/tiles.json", function(json){
         console.log(json)
         var files = json.files
         files.forEach(function(file){
           var filename = file.slice(0,-4);
           var fn_split = filename.split("_");
           fn_split[7] = fn_split[7].split("-")[0];
           var coors = [
             [Number(fn_split[4]), Number(fn_split[7])], // LU
             [Number(fn_split[6]), Number(fn_split[7])], // RU
             [Number(fn_split[6]), Number(fn_split[5])], // RB
             [Number(fn_split[4]), Number(fn_split[5])], // LB
           ];

           map.addLayer({
             "id": "overlay-layer-" + fn_split[1] + "-" + fn_split[2],
             "source": {
               type: "image",
               url: "https://gradecak.github.io/lsde04_data/png/"+file,
               coordinates: [
                 proj4('EPSG:28992','EPSG:4326',coors[0]), // LU
                 proj4('EPSG:28992','EPSG:4326',coors[1]), // RU
                 proj4('EPSG:28992','EPSG:4326',coors[2]), // RB
                 proj4('EPSG:28992','EPSG:4326',coors[3]), // LB
               ]
             },
             "type": "raster",
             "paint": {"raster-opacity": 0.65 }
           }, 'landcover_snow');

         })
       });

       $.getJSON("https://raw.githubusercontent.com/gradecak/lsde04_data/master/all_dikes_connected.GeoJSON", function(json) {
         json.features.forEach(function(featuresPart, featuresIndex, featuresArray) {
           var newArr = [];
           featuresArray[featuresIndex].geometry.coordinates[0].forEach(function(part, index, theArray) {
             if (index % 20 === 0) {
               newArr.push(proj4('EPSG:28992','EPSG:4326',theArray[index]));
             }
           });
           featuresArray[featuresIndex].geometry.coordinates[0] = newArr;
           map.addLayer({
             'id': 'dike-'+ featuresIndex,
             'type': 'fill',
             'source': {
               'type': 'geojson',
               'data': featuresArray[featuresIndex]
             },
             'paint': {
               'fill-color': '#ff4d27',
               'fill-opacity': 0.85
             }
           });
         });
       });

     });
    </script>

  </body>
</html>
